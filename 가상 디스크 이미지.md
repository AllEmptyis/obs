## 정의
- 가상 머신이 실제 디스크처럼 인식하도록 만든 **파일 기반 가상 저장장치**
- 가상화 환경에서 전체 디스크 내용을 하나의 파일([[QCOW2|.qcow2]], ,vmdk, .raw)로 만들어서 사용
	- 디스크 전체 상태(OS, 파일 시스템 등)을 하나의 파일에 담은 이미지
	- 운영체제의 부팅/실행을 위한 구성 요소 포함
### 저장 단위
##### block 
- 디스크에서 데이터를 저장/읽어오는 최소 단위 (게스트 OS가 작동하는 단위)
- 파일 시스템에 정의 된 블록 크기 기준 (ex.ext4: 4kb)
- 사용 이유
	- 디스크에서는 데이터를 블록(정해진 크기)로 나누어 저장
	- 하나의 블록이 4kb라면, 실제 파일 크기가 3kb여도 4kb로 저장 됨
##### 클러스터
- 이미지 포맷이 데이터를 저장할 때 사용하는 단위 (포맷에 따라 단위명 상이)
- 호스트에 실제 파일에는 해당 단위로 저장 됨
	- 보통 64kb
- 게스트OS 블록을 여러 개 묶어 저장 

## 역할
- OS 입장에서는 일반 `/dev/sda`, `C:\`드라이브로 인식
- 호스트 입장: HDD처럼 동작하는 파일
## 이미지 구성
1. 부트로더 (grub, systemd-boot)
	- OS를 부팅시키는 로더
2. 커널 이미지
3. [[파티션]] (MBR/GPT)
	- 디스크를 논리적으로 나누는 구조
		- ex) `/dev/sda1`
	- efi 파티션, 루트 파티션, swap 파티션 등
4. [[파일 시스템]]
	- 각 파티션 위에 생성 / 데이터를 저장, 관리하는 구조
	- `ext4`,`ntfs`,`vfat` 등
	- OS 구성 요소, 커널, 앱 실행 파일, 설정 파일, 사용자 데이터 등 저장
### 이미지 구성 예시
```
[ 전체 디스크 이미지 ]  
┌────────────────────────────┐  
│ GPT 파티션 테이블          │  
├────────────────────────────┤  
│ /dev/sda1 → EFI 파티션     │ ← vfat, 512MB  
│   ↳ /boot/efi              │  
├────────────────────────────┤  
│ /dev/sda2 → 루트 파티션    │ ← ext4, /  
│   ↳ /boot/grub             │ ← 부트로더 (GRUB2)  
│   ↳ /boot/vmlinuz-6.2.x    │ ← 커널  
│   ↳ /boot/initrd.img       │ ← initramfs  
│   ↳ /usr, /etc, /var 등    │  
├────────────────────────────┤  
│ /dev/sda3 → swap 파티션    │  
└────────────────────────────┘  
```
## 용도
1. VM 생성 / 복제
2. 백업, 복원
3. 마이그레이션
4. 배포
## 파일 포맷 종류
- raw
- [[QCOW2]]
- vmdk
- vhd
- ova/ovf
## 사용되는 기술 및 용어 정리
- raw가 아닌 대부분의 이미지 포맷은 CoW 기술을 활용하여 변경 된 부분만 저장하여 공간을 효율적으로 사용
- 메타데이터를 사용하여 호스트 입장에서는 하나의 디스크로 보이게 함
#### 메타데이터
- 가상 디스크 구조/상태를 관리하는 정보 
- 실제 데이터를 설명하고 관리하는 데이터
##### 항목 예시
- 디스크 포맷 버전
- 클러스터 크기
	- 데이터가 저장되는 단위 
- 전체 디스크 용량
	- vm이 보는 가상 디스크 크기 
- L1/L2 테이블
- Refcount Table
	- 클러스터 참조 횟수 (스냅샷, 공유 등 추적 용도)
- 백킹 파일 경로
#### Backing File (부모 이미지)
- 디스크의 이전 상태, 즉 생성 시 디스크가 백킹 파일을 참조하여 변경 된 내용만 저장 (CoW 기반)
	- 부모 이미지: 원본 디스크 (읽기/참조 기반)
	- 자식 이미지: 변경분을 저장하는 실제 실행 디스크
- 읽기 요청: 자식-> 원본(부모)이미지
- 쓰기 요청: 자식 디스크에만 기록
##### 사용 예시
- base.qcow2(부모이미지, OS 설치/초기 환경)
- dev01.qcow2(자식 이미지)
- 메타데이터를 통해 vm은 이것을 단일 디스크처럼 인식
#### CoW(Copy on Write)
- 기존 데이터는 그대로 유지하고 **변경 된 부분만 복사해서 새로 저장**하는 방식
##### 동작 방식
- 읽기: 원본 데이터 참조
- 쓰기: 변경 된 블록만 새로 복사해서 저장
##### 사용 예시
- 백킹파일 사용
	- 다수의 vm이 같은 원본 이미지를 공유할 때
	- 배포, 복제, 공간 절약 등이 목적
- 스냅샷
	- 스냅샷 찍은 뒤 이후 변경분만 저장
## 활용
- vm은 cpu,메모리,디스크 등 리소스를 갖는 실행 단위
- 가상 디스크 이미지 파일을 vm의 가상 디스크로 mount
- 예시
	```
	<!-- libvirt XML 예시 -->
	<disk type='file' device='disk'>
	  <driver name='qemu' type='qcow2'/>
	  <source file='/var/lib/libvirt/images/ubuntu.qcow2'/>
	  <target dev='vda' bus='virtio'/>
	</disk>
	```