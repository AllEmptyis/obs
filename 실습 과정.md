## 실습 단계
- [x] PLOS 업데이트
	```
	SBM_TEST(config)# os-update ftp://test:test123@192.168.212.225/PLOS-PASK-v2.2.7.4.0
	Firmware tool: Updating Firmware

	BEGIN: Downloading via FTP (2025-05-15 11:25:25,372)
	- [########################################] 100.0% (887,164,053 / 887,164,053)
	```
- [x] 라우팅 설정
- [x] SLB 생성
- [x] 서버 설정
	- [x] nginx 설치
- [ ] SLB 확인
- [x] H/C 확인

## 구성
### PAS-K
- 버전 확인
	```
	switch# show system
	
	================================================================================
	  SYSTEM
	 ------------------------------------------------------------------------------
	    System
	        Product Name     : PAS-K3200X
	        Serial Number    : R211K30000A03201
	        OS version       : v2.2.7.4.0
	        Mgmt IP Address  : 192.168.100.1/24
	        Mgmt MAC Address : 00:06:c4:90:03:92
	        SDRAM Size       : 16384MB
	        Storage Size     : 256.1GB
	        Log Storage Size : 212.9GB (used: 2.9G (2%))
	        System Uptime    : 2 minutes 27 seconds
	================================================================================
	```
- 라우팅 설정
	```
	root@exam:/# ip route add 192.168.211.0/24 via 10.10.10.1
	
	PAS-K(config)# route network 192.168.212.0/24 gateway 192.168.193.1
	
	PAS-K(config)# show interface
	
	================================================================================
	INTERFACE Configuration
	 ------------------------------------------------------------------------------
	  Name    Status MAC Address       IPv4 Address       Broadcast       RPF     Description
	  test    up     00:06:c4:90:03:93 192.168.193.181/24 192.168.193.255 default
	  default up     00:06:c4:90:03:93 10.10.10.1/24      10.10.10.255    default
	  mgmt    up     00:06:c4:90:03:92 192.168.100.1/24   192.168.100.255 default
	================================================================================
	
	PAS-K(config)# show route
	
	================================================================================
	  ROUTE
	 ------------------------------------------------------------------------------
	    Default-Gateway      : 192.168.193.1
	
	    Network
	       Destination      Gateway       Interface Priority HC-ID HC-Type HC-Result Description
	       10.10.10.0/24    0.0.0.0       default
	       192.168.193.0/24 0.0.0.0       test
	       192.168.212.0/24 192.168.193.1 test      10
	================================================================================
	
	- mgmt custom id X 
	
	```
- vlan
	```
	PAS-K(config)# show vlan
	
	================================================================================
	VLAN Configuration
	--------------------------------------------------------------------------------
	          |         |                                 |          |
	          |         |                   1 1 1 1 1 1 1 |          |
	VLAN Name | VLAN ID | 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 | TBM      | Description
	--------------------------------------------------------------------------------
	default   | 1       | . u u u u u u u u u u u u u u u | disable  |
	test      | 193     | u . . . . . . . . . . . . . . . | disable  |
	================================================================================
	
	```
- H/C
	```
	PAS-K(config-health-check[1])# current
	
	================================================================================
	  HEALTH-CHECK: 1
	 ------------------------------------------------------------------------------
	    ID                   : 1
	    Type                 : ip-tunnel-tcp
	    Timeout              : 3
	    Interval             : 5
	    Retry                : 3
	    Recover              : 0
	    Status               : enable
	    Graceful Shutdown    : disable
	    Description          :
	
	    --- Option ---------------------------------------------------------------
	    SIP                  :
	    TIP                  :
	    Inner TIP            : 192.168.193.50
	    DIP                  :
	    Port                 : 0
	================================================================================
	```
- real
	```
	PAS-K(config-real[1])# current
	
	================================================================================
	  REAL: 1
	 ------------------------------------------------------------------------------
	    ID                       : 1
	    Name                     : server
	    RIP                      : 10.10.10.10
	    Rport                    : 80
	    SSL Rport                :
	    Priority                 : 0
	    Weight                   : 1
	    Interface                :
	    Site                     :
	    MAC Address              :
	    Backup                   :
	    Graceful Shutdown        : disable
	    Manual-Resume            : disable
	    SP Filter                :
	    SP Filter Group          :
	    Domain Filter            :
	    Max Connection           : 0
	    Max upload-bandwidth     : 0
	    Max download-bandwidth   : 0
	    Pool Size                : 10000
	    Pool Age                 : 3600
	    Pool Reuse               : 100
	    Pool Src MASK            : 32
	    Surge Base Threshold     : 0
	    Surge Upper Limit        : 0
	    Src NAT IP               :
	    Service-IP               :
	    Status                   : enable
	    Description              :
	
	    Health Check             :
	================================================================================
	```
### Server (ubuntu)
- ip tunnel 지원 확인
	![[Pasted image 20250515172853.png]]
	```
	root@exam:/# modprobe ipip
	root@exam:/# lsmod | grep ipip
	ipip                   20480  0
	tunnel4                16384  1 ipip
	ip_tunnel              24576  1 ipip
	```
- 루프백 인터페이스에 vip 설정
	```
	root@exam:/# ip addr add 192.168.193.50/32 dev lo
	
	root@exam:/# ip addr
	1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
	    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
	    inet 127.0.0.1/8 scope host lo
	       valid_lft forever preferred_lft forever
	    inet 192.168.193.50/32 scope global lo
	       valid_lft forever preferred_lft forever
	```
- vip 에 대해 arp 응답 하지 않도록 설정 (loopback 인터페이스에 vip 설정 시 굳이 필요 없음)
	![[Pasted image 20250515173108.png]]
	```
	root@exam:/# sysctl -w net.ipv4.conf.lo.arp_ignore=1
	net.ipv4.conf.lo.arp_ignore = 1
	root@exam:/# sysctl -w net.ipv4.conf.all.arp_ignore=1
	net.ipv4.conf.all.arp_ignore = 1
	root@exam:/# sysctl -w net.ipv4.conf.lo.arp_announce=2
	net.ipv4.conf.lo.arp_announce = 2
	root@exam:/# sysctl -w net.ipv4.conf.all.arp_announce=2
	net.ipv4.conf.all.arp_announce = 2
	root@exam:/# 
	root@exam:/# sysctl -p (적용)
	```

- TCP/IP 응답을 위해 rport(80)을 리스닝 할 nginx 설치
	```
	root@exam:/# apt install nginx -y
	
	root@exam:/# systemctl status nginx
	● nginx.service - A high performance web server and a reverse proxy server
	   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
	   Active: active (running) since Fri 2025-05-16 10:05:55 KST; 1min 16s ago

	root@exam:/# netstat -lntup grep :80
	Active Internet connections (only servers)
	Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
	tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      5439/nginx: master  
	tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      662/systemd-resolve 
	tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      957/sshd            
	tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      2285/cupsd          
	tcp6       0      0 :::80                   :::*                    LISTEN      5439/nginx: master  
	```
- [[리눅스 커널 기능|rp_filter]] 해제 필요
	- rt_filter는 패킷이 들어온 인터페이스로만 나가게 하는 기능 (보안 필터링 정책)
	- lo -> en1 로 통신 될 수 있도록 함
	```
	root@exam:/# cat /proc/sys/net/ipv4/conf/all/rp_filter
	1  ---> 현재 rp_filter 동작 중
	
	root@exam:/# sysctl -w net.ipv4.conf.all.rp_filter=0
	net.ipv4.conf.all.rp_filter = 0
	root@exam:/# sysctl -w net.ipv4.conf.default.rp_filter=0
	net.ipv4.conf.default.rp_filter = 0
	root@exam:/# 
	root@exam:/# cat /proc/sys/net/ipv4/conf/all/rp_filter
	0
	```
- ip route get 설정 (필수X)
	- 특정 IP로 응답을 보낼 때 어느 인터페이스로 보낼지 설정

#### 오류_IPIP프로토콜 자동 미지원
- 커널에서 자동으로 IPIP프로토콜을 지원하지 않는 경우 (protocol 4 destination unreachable)
	```
	tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
	listening on eno1, link-type EN10MB (Ethernet), capture size 262144 bytes
	13:06:01.983492 00:06:c4:90:03:93 > d4:ae:52:ca:a2:98, ethertype IPv4 (0x0800), length 94: 10.10.10.1 > 10.10.10.10: 10.10.10.1.32623 > 192.168.193.50.80: Flags [S], seq 2115417017, win 64240, options [mss 1460,sackOK,TS val 658992584 ecr 0,nop,wscale 8], length 0 (ipip-proto-4)
	13:06:01.983539 d4:ae:52:ca:a2:98 > 00:06:c4:90:03:93, ethertype IPv4 (0x0800), length 122: 10.10.10.10 > 10.10.10.1: ICMP 10.10.10.10 protocol 4 port 60 unreachable, length 88
	```
- 해결
	- ipip 패킷을 받을 터널 인터페이스를 수동으로 생성
	- remote `[L4 인터페이스 ip]` local `[server real ip]`
	```
	root@exam:/# ip tunnel add tun0 mode ipip remote 10.10.10.1 local 10.10.10.10
	root@exam:/# ip link set tun0 up
	```

#### 오류_서버에서 클라이언트로 가는 패킷 경로(해결x)
- 서버에서 클라이언트로 패킷을 전송할 때 다른 인터페이스를 타고 나가는 경우 (사내망 eno2)
	- 증상: 서버에서 reset을 보냄
	```
	root@exam:/# ip route get 192.168.212.225
	192.168.212.225 via 192.168.193.1 dev eno2 src 192.168.193.100 uid 0 
	```
- 해결
	- 정책 기반 라우팅 (policy routing) 사용
	```
	root@exam:/# ip route add 192.168.193.1/32 dev eno1 table 100
	root@exam:/# ip route add default via 192.168.193.1 dev eno1 table 100
	root@exam:/# ip rule add from 192.168.193.50 lookup 100
	```
## 결과
### H/C 성공 확인
- PAS-K
	```
	    Real
	       ID    Name   RIP         Rport Backup Status G-SHDN  Health Cause State-Time      Description
	       1     server 10.10.10.10 80           enable disable ACT          0 days 00:03:27
	
	    Health-Check-Info
	       ID    Type          Port  Status
	       1     ip-tunnel-tcp 0     enable
	```
- server (헬스체크 응답)
	- 10.10.10.1 > 10.10.10.10   :    10.10.10.1.41699 > 192.168.193.50.80  (outer : inner)
	- rip로 패킷을 보내서 실제 세션 (193.50:80) 이 vip로 리스닝 중인지 확인
```
root@exam:/# tcpdump -nei eno1
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eno1, link-type EN10MB (Ethernet), capture size 262144 bytes
13:25:57.250148 00:06:c4:90:03:93 > d4:ae:52:ca:a2:98, ethertype IPv4 (0x0800), length 94: 10.10.10.1 > 10.10.10.10: 10.10.10.1.41699 > 192.168.193.50.80: Flags [S], seq 1932456791, win 64240, options [mss 1460,sackOK,TS val 660187835 ecr 0,nop,wscale 8], length 0 (ipip-proto-4)
13:25:57.250210 d4:ae:52:ca:a2:98 > 00:06:c4:90:03:93, ethertype IPv4 (0x0800), length 74: 192.168.193.50.80 > 10.10.10.1.41699: Flags [S.], seq 3296167379, ack 1932456792, win 65160, options [mss 1460,sackOK,TS val 2252583236 ecr 660187835,nop,wscale 7], length 0
13:25:57.250325 00:06:c4:90:03:93 > d4:ae:52:ca:a2:98, ethertype IPv4 (0x0800), length 86: 10.10.10.1 > 10.10.10.10: 10.10.10.1.41699 > 192.168.193.50.80: Flags [.], ack 1, win 251, options [nop,nop,TS val 660187835 ecr 2252583236], length 0 (ipip-proto-4)
13:25:57.250607 00:06:c4:90:03:93 > d4:ae:52:ca:a2:98, ethertype IPv4 (0x0800), length 86: 10.10.10.1 > 10.10.10.10: 10.10.10.1.41699 > 192.168.193.50.80: Flags [F.], seq 1, ack 1, win 251, options [nop,nop,TS val 660187836 ecr 2252583236], length 0 (ipip-proto-4)
13:25:57.250699 d4:ae:52:ca:a2:98 > 00:06:c4:90:03:93, ethertype IPv4 (0x0800), length 66: 192.168.193.50.80 > 10.10.10.1.41699: Flags [F.], seq 1, ack 2, win 510, options [nop,nop,TS val 2252583236 ecr 660187836], length 0
```
### SLB 실패
- L2 dsr로 재시도 예정